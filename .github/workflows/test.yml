name: CI - tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services: {}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for cross-builds, optional)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Create /proc snapshot for tests
        run: |
          ./tests/create_proc_snapshot.sh ./proc_snapshot

      - name: Build runtime image for tests
        run: |
          docker build --target runtime -t system-monitor-test:ci .

      - name: Run tests inside container (with /proc and /sys mounted)
        run: |
          docker run --rm \
            --mount type=bind,source=${{ github.workspace }},target=/workdir \
            -e COLLECTION_INTERVAL=0 \
            -e OUTPUT_FORMAT=text \
            -e HOST_PROC=/host/proc \
            --workdir /workdir \
            system-monitor-test:ci \
            bash -c "chmod +x /workdir/tests/test_core_metrics.sh && /workdir/tests/test_core_metrics.sh"
          # note: running tests inside inside the built image using a copied /proc snapshot

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: error

      # - name: Run ShellCheck on scripts
      #   run: |
      #     # target all scripts in repo
      #     find . -type f -name ''.sh -print0 | xargs -0 shellcheck -x -S info


